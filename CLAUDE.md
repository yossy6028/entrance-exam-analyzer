# Claude Code Instructions - 入試問題分析プロジェクト

## プロジェクト概要
このプロジェクトは国語の入試問題PDFから出題傾向と出典を自動抽出・分析するシステムです。

## 重要な制約事項
- OCRツールはBunkoOCRを使用（Google Cloud Vision APIは使用しない）
- 縦書きPDFの処理に特化
- 出力はExcel形式

## 技術スタック
- Python 3.8+
- BunkoOCR（macOSアプリケーション）
- pandas, openpyxl
- 画像処理: PIL/Pillow

## 要件定義書・Todoリスト
- `/requirements_doc.md`に詳細な要件定義を保管

## 開発時の注意点
1. OCR結果の精度は100%ではないため、エラーハンドリングを適切に実装
2. 縦書きテキストの処理には特別な配慮が必要
3. 設問パターンの認識は正規表現を活用

## テスト実行
実装完了後は必ず以下を実行：
- サンプルPDFでの動作確認
- エラーケースのテスト（画質の悪いPDF等）

## Excelデータベース管理ルール

### 基本構造
- **1シート = 1学校**のルールを厳守
- シート名は学校名（例：開成中学校、渋渋中学校、桜蔭中学校）
- 各シートには複数年度のデータを時系列で格納

### 列構造
基本情報:
- 年度（整数型）
- 総設問数
- 総文字数
- 大問数

大問別情報（大問1〜大問n）:
- 大問n_ジャンル（小説・物語、評論・論説、随筆・エッセイ）
- 大問n_テーマ（人間関係・成長、自然・環境、社会・文化、科学・技術など）
- 大問n_著者
- 大問n_作品
- 大問n_設問数
- 大問n_文字数

設問タイプ別集計:
- 記述_問題数
- 選択_問題数
- 漢字・語句_問題数
- 抜き出し_問題数

### データ更新時の処理
1. 既存シートがある場合：同じ年度のデータがあれば更新、なければ追加
2. 新規学校の場合：新しいシートを作成してデータを追加
3. 年度順にソート（古い年度から新しい年度へ）
4. 不要なSheet1などは作成しない

### Excelファイルの破損対策
- データ更新時は必ず`if_sheet_exists='replace'`を使用
- 不要なシートや列を作成しない
- シンプルな構造を維持する

## OCRシステムの移行について

### BunkoOCRへの移行（2025年8月）
- Google Cloud Vision APIから日本語特化のBunkoOCRへ移行
- 縦書き文書の認識精度が大幅に向上
- 特に古い入試問題（2015年など）でVision APIでは認識困難だった箇所も正確に読み取り可能

### 新しい統合ワークフロー（2025年8月3日更新）
1. **アプリケーション起動**: `python3 run_app.py`
2. **学校・年度を指定**: GUIで学校名と年度を選択
3. **PDFファイル選択**: ファイルブラウザから該当PDFを選択
4. **BunkoOCR起動**: 自動的にBunkoOCRが起動し、選択したPDFが開く
5. **OCR処理**: ユーザーが手動でOCRボタンをクリック
6. **自動分析**: OCR完了後、自動的にテキスト分析を実行
7. **Excel記録**: 分析結果を自動的にデータベースに保存

### 使い方
```bash
cd /Users/yoshiikatsuhiko/entrance_exam_analyzer
python3 run_app.py
```

### 旧ワークフロー（手動）
1. PDFファイルをBunkoOCRアプリで開く
2. OCR処理を実行（手動操作）
3. 結果をiCloudフォルダから自動取得
4. テキスト分析とExcel出力は既存のPythonスクリプトで処理

### 注意事項
- `.env`ファイルのGoogle Cloud認証情報は不要となったが、互換性のため残存
- Vision API関連のインポートがあるスクリプトは動作しない
- 新規分析にはBunkoOCR用のスクリプト（`analyze_*_bunko.py`）を使用すること