# デバッグログ - 入試問題分析システム

## 2025年1月 - 聖光学院セクション分割問題

### 問題の概要
聖光学院2025年の入試問題分析で、実際は3つの大問なのに5つのセクションとして誤認識され、Excel出力で「その他2」「その他3」に不適切なデータが格納される問題が発生。

### 根本原因

#### 1. OCRテキストの構造的問題
- **設問が本文と分離して配置**：OCRの結果、設問（問一〜問八）が本文の後にまとめて出力されていた
- **出典位置の誤解釈**：出典「――著者名『作品名』による」が本文の終了位置として扱われ、その後の設問が別セクションとして認識された

#### 2. 設問番号の連続性を無視
- **問題のパターン**：
  - セクション2: 問一、問二
  - セクション3: 問六、問七、問八（問三〜問五が欠落）
  - セクション4: 問一、問二、問四
  - セクション5: 問五、問六、問七、問八
- **本来の構造**：
  - 大問1: 漢字・語句
  - 大問2: 森沢明夫（問一〜問八の完全なセット）
  - 大問3: 永井佳子（問一〜問八の完全なセット）

#### 3. 大問識別ロジックの問題
```python
# 問題のあったコード
def _identify_and_divide_sections(self, text: str, sources: List[Dict]) -> List[Dict]:
    # 大問番号（一、二、三、四）を探すが、聖光学院のOCRテキストには存在しなかった
    section_patterns = [
        r'[一二三四五六七八九十]、',
        r'[１-４1-4][\s　、]',
        r'第[一二三四五六七八九十]問',
    ]
    # これらのパターンが見つからない場合、出典位置で機械的に分割
```

### 発見された問題点

1. **設問の位置情報を考慮していない**
   - 設問番号の連続性チェックがない
   - 設問が本文から離れて配置される可能性を想定していない

2. **OCR特有の問題への対処不足**
   - PDFの2段組みレイアウトがOCRで1列に変換される
   - 設問と本文の物理的な配置関係が失われる

3. **検証ロジックの欠如**
   - セクション分割後の妥当性検証がない
   - 設問番号の飛びを異常として検出できない

### 実装した対策

#### 1. 設問番号の連続性チェック
```python
def validate_section_questions(questions: List[Dict]) -> bool:
    """設問番号の連続性を検証"""
    numbers = [q['number'] for q in questions]
    # 問一から始まり、連続しているかチェック
    expected = ['一', '二', '三', '四', '五', '六', '七', '八']
    # 番号に飛びがある場合は警告
```

#### 2. 手動セクション定義オプション
```python
def fix_and_reanalyze():
    """セクション分割を修正して再分析"""
    sections = []
    
    # 出典位置を基準に、設問も含めた範囲でセクションを定義
    morisawa_start = text.find('送られてきたメール')  # 本文開始
    morisawa_end = text.find('――永井佳子')  # 次の出典まで
```

#### 3. 新しいExcel形式の採用
- 「大問1, 大問2, 大問3, 大問4」→「文章1, 文章2, 文章3, その他1, その他2, その他3」
- 内容種別での分類により、大問番号の曖昧さを回避

### 今後の改善提案

#### 短期的対策
1. **設問検証機能の追加**
   - 設問番号の連続性チェック
   - 設問数の妥当性検証（通常は各大問5〜10問程度）
   
2. **デバッグ出力の強化**
   - セクション分割時に設問番号リストを出力
   - 異常を検出したら警告表示

3. **学校別パターンの記録**
   ```python
   SCHOOL_PATTERNS = {
       '聖光学院': {
           'section_count': 3,  # 通常3大問
           'has_kanji': True,   # 漢字問題あり
           'question_pattern': '問[一-八]'  # 設問形式
       }
   }
   ```

#### 長期的対策
1. **機械学習による大問識別**
   - 設問パターンと本文の関係を学習
   - OCRレイアウトの復元

2. **PDFレイアウト解析の導入**
   - テキスト抽出前にレイアウト構造を保持
   - 2段組みや設問配置を考慮

3. **検証用テストスイートの構築**
   - 各学校の過去問での回帰テスト
   - エッジケースの収集と対策

### 教訓
- **OCRの出力順序を過信しない**：物理的なレイアウトと異なる可能性
- **設問の連続性は重要な手がかり**：番号の飛びは異常のサイン
- **ユーザーフィードバックの重要性**：「その他2、その他3が気になる」という指摘が問題発見につながった

### 関連ファイル
- `/modules/final_content_extractor.py` - セクション分割ロジック
- `/modules/content_type_formatter.py` - 新Excel形式フォーマッター
- `/fix_section_division.py` - 修正版の分析スクリプト
- `seiko_debug_result.json` - デバッグ用分析結果
- `seiko_fixed_result.json` - 修正後の分析結果