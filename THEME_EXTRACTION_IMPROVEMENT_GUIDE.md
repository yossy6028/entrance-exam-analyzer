# 社会科目入試問題テーマ抽出システム改善ガイド

## 問題の概要

従来のテーマ抽出システムでは以下の問題が発生していました：

- **OCRノイズの混入**: 「受験番号」「採点欄」「解答用紙」等の管理用語が含まれる
- **参照型問題の誤解析**: 「下線④について」「この人物について」等の参照文字列がテーマとして抽出される
- **表面的な分析**: 単純なキーワードマッチングによる精度の低いテーマ検出

## 実装した解決策

### 1. 改善されたテーマ抽出システム (`modules/improved_theme_extractor.py`)

#### 主要機能:
- **OCRノイズ除去**: 管理用語、指示文、参照マーカーを自動除去
- **参照コンテンツ抽出**: 「下線①」等の参照から実際の内容を特定
- **高度なテーマ検出**: 文脈を考慮した重み付きキーワード分析

#### 対応するノイズパターン:
```python
OCR_NOISE_PATTERNS = {
    'administrative': ['受験番号', '採点欄', '解答用紙', '答案用紙', '記入欄'],
    'formatting_instructions': ['この人物について', 'あらわしている', 'まちがっている文章を'],
    'reference_markers': ['下線①について', '傍線部アについて', '※印について']
}
```

### 2. 統合システム

既存の `UniversalAnalyzer` に改善されたテーマ抽出機能を統合：
- フォールバック機能付きで信頼性を確保
- 信頼度30%以上の場合のみ新システムを使用
- エラー時は従来システムに自動切り替え

## テスト結果

### 成功した機能 (3/4)
✅ **OCRノイズ除去**: 管理用語・指示文を確実に除去  
✅ **改善されたテーマ検出**: 91.5%、85.7%、83.6%の高い信頼度でテーマを検出  
✅ **UniversalAnalyzer統合**: 既存システムとの正常な連携  

### 改善が必要な機能 (1/4)
❌ **参照コンテンツ抽出**: 一部の参照型問題で部分的な抽出

## 使用方法

### 1. 基本的な使用

```python
from modules.improved_theme_extractor import ImprovedThemeExtractor

extractor = ImprovedThemeExtractor()

# OCRで抽出されたテキストを分析
text = """
受験番号: 12345
この人物について述べなさい。
友達と一緒に遊んだ楽しい思い出がある。
下線①について答えなさい。
"""

result = extractor.analyze_text(text)

print(f"テーマ: {result.theme}")
print(f"信頼度: {result.confidence:.1f}%")
print(f"除去されたノイズ: {result.noise_removed}")
```

### 2. 既存システムとの統合

既存の `UniversalAnalyzer` を使用すると自動的に改善されたテーマ抽出が適用されます：

```python
from modules.universal_analyzer import UniversalAnalyzer

analyzer = UniversalAnalyzer()
result = analyzer.analyze(ocr_text, "学校名", "2025")

# 改善されたテーマが自動的に適用される
print(f"テーマ: {result.theme}")
```

## 改善の効果

### Before（従来システム）
- **誤抽出例**: 「この人物」「下線④」「受験番号」等がテーマとして抽出
- **低精度**: 表面的なキーワードマッチングのみ
- **ノイズ混入**: OCRの管理用語が分析対象に含まれる

### After（改善システム）
- **正確な抽出**: 「友情・人間関係」「自然・環境」「科学・技術・未来」等の適切なテーマ
- **高信頼度**: 80-90%台の信頼度を実現
- **クリーンな分析**: OCRノイズを自動除去してから分析

## 今後の改善点

### 1. 参照コンテンツ抽出の精度向上
- より高精度な参照マーカーの検出
- 複数の参照が重複する場合の処理改善

### 2. テーマカテゴリの拡張
- 学校固有のテーマパターンへの対応
- 年度による傾向変化への適応

### 3. パフォーマンス最適化
- 大量のテキスト処理の高速化
- メモリ使用量の最適化

## ファイル構成

```
modules/
├── improved_theme_extractor.py    # 新しいテーマ抽出システム
├── universal_analyzer.py          # 統合された分析システム
└── [その他既存ファイル]

test_improved_theme_extraction.py  # 総合テストファイル
```

## 実運用での注意事項

1. **テスト実行の推奨**: 新しいPDFファイルを処理する前に `test_improved_theme_extraction.py` を実行
2. **信頼度の確認**: テーマ抽出結果の信頼度が30%未満の場合は手動確認を推奨
3. **ログの確認**: エラーが発生した場合は従来システムにフォールバックされる

## サポートと問い合わせ

このシステムに関する技術的な質問や改善提案がございましたら、開発チームまでお問い合わせください。

---

**最終更新**: 2025年8月11日  
**バージョン**: 1.0  
**テスト合格率**: 75% (3/4テスト成功)